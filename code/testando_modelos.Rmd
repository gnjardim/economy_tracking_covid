---
title: "Testando Modelos"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 6, fig.height = 3.2)


library(tidyverse)
library(lubridate)
library(janitor)
library(modelr)
library(zoo)
library(forecast)
library(kableExtra)


source('counterfactual_energy.R', encoding = 'UTF-8')
theme_set(theme_bw())
```

## Objetivo

Relatório tem como objetivo testar o modelo **BSM** utilizado para contrafactual do consumo de energia. 


```{r, include = FALSE, warning = FALSE}
energy <- read_csv2("../input/energia_data.csv") %>% 
    rename(ramo = `Ramo de atividade`) %>% 
    mutate(Estado = iconv(Estado, from = "UTF-8", to = "ASCII//TRANSLIT") %>% 
               trimws()) %>% 
    clean_names() %>% 
    mutate(data = as.Date(data, "%d/%m/%Y")) %>% 
    arrange(data, classe, ramo) %>% 
    group_by(data, estado, classe) %>% 
    summarise(consumo = sum(consumo_m_wm))

bsm_model <- counterfact_model(energy)
```


```{r echo=FALSE}
UF <- "Acre"
teste_modelos <- function(UF){
    
    # modelo
    modelo <- bsm_model[[UF]]
    
    # coeficientes
    table <- kable(modelo$coef)

    # resíduos
    plot_residuo <- checkresiduals(modelo)

    # fitted x observed
    
    datas <- seq.Date(from = as.Date("2018-07-01"), 
                      to   = as.Date("2020-02-01"),
                      by   = "month")
    
    
    df <- tibble(date  = datas,
                 sm    = fitted(modelo)[,1], 
                 serie = modelo$data %>% as.numeric())

    plot <- autoplot(modelo$data) +
    autolayer(fitted(modelo, h=1))
    
    # plot
    plot_fit_sa <- ggplot(df, mapping = aes(x = date)) + 
      geom_line(aes(y = sm), col = 'blue') +
      geom_line(aes(y = serie), col = 'red')
    
    return(list(table, plot_residuo, plot_fit_sa))
}

nome_estados <- unique(energy$estado)
list_residual <- map(nome_estados, teste_modelos)
```

