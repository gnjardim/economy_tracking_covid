---
title: "Testando Modelos"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 6, fig.height = 3.2)


library(tidyverse)
library(lubridate)
library(janitor)
library(modelr)
library(dplyr)
library(rlang)
library(zoo)
library(forecast)
library(kableExtra)


source('code/counterfactual_energy.R', encoding = 'UTF-8')
theme_set(theme_bw())
```

## Objetivo

Relatório tem como objetivo testar o modelo **BSM** utilizado para contrafactual do consumo de energia. 


```{r, include = FALSE, warning = FALSE}
energy <- read_csv2("input/energia_data.csv") %>% 
    rename(ramo = `Ramo de atividade`) %>% 
    mutate(Estado = iconv(Estado, from = "UTF-8", to = "ASCII//TRANSLIT") %>% 
               trimws()) %>% 
    clean_names() %>% 
    mutate(data = as.Date(data, "%d/%m/%Y")) %>% 
    arrange(data, classe, ramo) %>% 
    group_by(data, estado, classe) %>% 
    summarise(consumo = sum(consumo_m_wm))

bsm_model <- counterfact_model(energy)
```


```{r , echo=FALSE}
teste_modelos <- function(UF){
#Modelo
    modelo <- bsm_model[[paste0(UF)]]
    
# Básicos do Modelo
    table <- kable(modelo$coef)
    
#Limpando base 
    df <- energy %>% 
       dplyr:: filter(estado == UF)
#Vendo Resíduo
    plot_residuo <- forecast::checkresiduals(modelo)

# Fited x SA
    sm <- tsSmooth(modelo)
    modelo_sa <- df - sm[,1]

    plot_fit_sa <- ggplot() + 
      geom_line(df,sm[,1],col='blue')+
      geom_line(fitted(modelo)[,1],col='red')+
      geom_line(modelo.sa, col='black')
    
return(list(plot_residuo,plot_fit_sa))
}

Estados <- unique(energy$estado)

list_residual <- lapply(Estados,teste_modelos)

```

