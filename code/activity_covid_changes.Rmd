---
title: "Atividade x COVID"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 6, fig.height = 3.2)

library(tidyverse)
library(lubridate)
library(janitor)
library(modelr)
library(dplyr)
library(rlang)
library(zoo)
library(writexl)

theme_set(theme_bw())
```

```{r, include = FALSE, warning = FALSE}
# google mobility report
mobility <- read_csv("../input/Global_Mobility_Report.csv") %>% 
    filter(country_region == "Brazil") %>% 
    mutate(sub_region_1    = str_remove_all(sub_region_1, "State of "),
           iso_3166_2_code = str_remove_all(iso_3166_2_code, "BR-")) %>%
	mutate(across(contains("baseline"), ~ 1 + ./100))

# energy data (não tem RR)
energy <- read_csv2("../input/energia_data.csv") %>% 
    rename(ramo = `Ramo de atividade`) %>% 
    mutate(Estado = iconv(Estado, from = "UTF-8", to = "ASCII//TRANSLIT") %>% 
                    trimws()) %>% 
    clean_names() %>% 
    mutate(data        = as.Date(data, "%d/%m/%Y")) %>% 
    arrange(data, classe, ramo) %>% 
    group_by(data, estado, classe) %>% 
    summarise(consumo = sum(consumo_m_wm))
    
# https://covid.saude.gov.br/
covid <- read_csv2("../input/PAINEL_COVIDBR.csv") %>% 
    filter(!is.na(estado)) %>% 
    mutate(date = as.Date(data, "%d/%m/%Y"))


# divide into brazil and states -------------------------------------------
brasil <- covid %>% 
    group_by(date) %>% 
    summarise(last_available_deaths    = sum(obitosAcumulado),
              last_available_confirmed = sum(casosAcumulado)) %>% 
    full_join(mobility %>% filter(is.na(sub_region_1))) %>% 
    select(-starts_with("country_region"), -starts_with("sub_region")) %>% 
    arrange(date)

uf_estado <- owdbr::uflist()

estados <- covid %>% 
    group_by(estado, date) %>%
    summarise(last_available_deaths    = sum(obitosAcumulado),
              last_available_confirmed = sum(casosAcumulado)) %>%
    rename(state = estado) %>% 
    full_join(mobility %>% filter(!is.na(sub_region_1)),
              by = c("state" = "iso_3166_2_code", "date" = "date")) %>%
    select(-starts_with("country_region"), -starts_with("sub_region"),  -starts_with("census_fips")) %>% 
    left_join(uf_estado, by = c("state" = "UF")) %>%
    rename(estado = State) %>% 
    arrange(regiao, state, date)

```

```{r include = FALSE}
# calculate empirical relation --------------------------------------------
# The empirical relationship between mobility and GDP growth rate across economies in the first quarter of 2020 is used to convert a country’s economic activity based on people’s mobility levels.

relation_eq <- function(mobility) {
    activity <- (0.3886 * mobility + 0.61) + 100
}


# doubling days of covid --------------------------------------------------
# More precisely, it is days between the current date (the date at which the measurement is taken) and the most recent prior date at which the confirmed cases were half the current level

nearest_n <- function(x, num) {
    x[which.min(abs(x - num))]
}

doubling_days <- function(half_num, current_date, df) {
    
    # get only previous dates
    half_cases <- df %>% 
        filter(date < current_date)
    
    # get nearest number of cases
    n_half <- nearest_n(half_cases$last_available_confirmed, half_num)
    
    # find last possible date
    last_date <- half_cases %>% 
        filter(last_available_confirmed == n_half) %>% 
        slice(n())
    
    return(last_date$date)
}

create_columns <- function(df) {
    
    post_df <- df %>% 
		mutate(dist_date   = as.numeric(date - doubl_dates),
			   mobility    = ((retail_and_recreation_percent_change_from_baseline + 
			   				grocery_and_pharmacy_percent_change_from_baseline) / 2 +  
			   					workplaces_percent_change_from_baseline) / 2,
			   smth_date   = rollmean(dist_date, 7, na.pad = T, align = "right"),
			   smth_mob    = rollmean(mobility, 7, na.pad = T, align = "right"),
			   activity    = relation_eq(smth_mob)
	    	  )
    
}


# run functions in data ---------------------------------------------------
brasil <- brasil %>% 
    mutate(across(matches("last_available"), ~replace(., is.na(.), 0))) %>% 
    mutate(half_cum_cases  = last_available_confirmed / 2,
           half_cum_deaths = last_available_deaths / 2)


doubl_dates <- map2(brasil$half_cum_cases, brasil$date, 
                    ~ doubling_days(.x, .y, brasil)) %>% 
    unlist()

brasil_df <- brasil %>% 
    mutate(doubl_dates = c(NA, doubl_dates) %>% as_date()) %>% 
    create_columns() %>% 
    filter(!is.na(mobility))
```

# Usando dados de mobilidade  

## Brasil  

```{r echo = FALSE, warning = FALSE}
ggplot(brasil_df, aes(x = smth_date, y = smth_mob)) +
    geom_path(color = "steelblue") +
    geom_hline(yintercept = 1, color = "red") +
    xlim(0, 40) + 
    ylab("Mobility Index") + xlab("Doubling days of confirmed cases") 
```


\pagebreak
```{r include = FALSE}
doubl_dates_st <- function(df) {
    dates <- map2(df$half_cum_cases, df$date, ~ doubling_days(.x, .y, df)) %>%
        unlist()
    
    df_dt <- df %>% 
        mutate(doubl_dates = c(NA, dates)) %>% 
        mutate(doubl_dates = ifelse(half_cum_cases == 0, NA, doubl_dates) %>% as_date())
    
    return(df_dt)
}

# run functions in data ---------------------------------------------------
# states 
estados <- estados %>%
    mutate(across(matches("last_available"), ~replace(., is.na(.), 0))) %>% 
    mutate(half_cum_cases  = last_available_confirmed / 2,
           half_cum_deaths = last_available_deaths / 2) %>% 
    group_by(state)

# split by state
list_estados <- group_split(estados)

bases_estados_df <- map(list_estados, doubl_dates_st) %>% 
    bind_rows() %>% 
    group_by(state) %>% 
    arrange(date) %>% 
    fill(doubl_dates) %>%
    ungroup() %>%
    arrange(state, date, regiao) %>% 
    create_columns() %>% 
    filter(!is.na(mobility))

```

```{r include = FALSE}
plot_activity_mobility <- function(df) {
    
    p <- ggplot(df, aes(x = smth_date, y = smth_mob)) +
		geom_path(color = "steelblue", size = 0.8) +
		#geom_vline(xintercept = 19, linetype = "dotted", size = 0.8) +
		#geom_point(data = brasil_mob_b, shape = 22, fill = "white") +
        geom_hline(yintercept = 1, color = "red") +
        xlim(0, 40) + 
		facet_wrap(~ state) +
		ylab("Mobility Index") + xlab("Doubling days of confirmed cases")
    
    return(p)
}


plot_regiao <- function(reg) {
    
    base_regiao <- bases_estados_df %>% 
        filter(regiao == reg)
    
    return(plot_activity_mobility(base_regiao)) 
}
```

## Região Sudeste
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao("Sudeste")
```

\pagebreak
## Região Sul
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 3}
plot_regiao("Sul")
```

\pagebreak
## Região Centro-Oeste
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao("Centro-Oeste")
```

\pagebreak
## Região Nordeste
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 9}
plot_regiao("Nordeste")
```

\pagebreak
## Região Norte
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 9}
plot_regiao("Norte")
```

\pagebreak
# Usando dados de energia

Para definir o contrafactual, fazemos duas regressões para cada estado,uma com tendência quadrática e outra sem tendência com os dados de 08/2018 até 02/2020, da seguinte forma:

+ Com tendência quadrática
\begin{equation}
\begin{split} \label{reg_energia_com_tendencia}
\text{Consumo Diario}{t} = \beta_0 & + \sum{i=2}^{3} \psi_i D_{\text{ano}{it}}+ \sum{i=2}^{52} \delta_i D_{\text{Semana}{it}} + \sum{i=2}^{7} \lambda_i D_{\text{dia da semana}_{it}} + \\
&\quad + \sum_{i=2}^{k} \theta_i D_{\text{feriado}_{it}} + \phi_1t + \phi_2t^2 + \epsilon_t
\end{split}
\end{equation}


+Sem tendência 
\begin{equation}
\begin{split} \label{reg_energia_sem_tendencia}
\text{Consumo Diario}{t} = \beta_0 & + \sum{i=2}^{3} \psi_i D_{\text{ano}{it}}+ \sum{i=2}^{52} \delta_i D_{\text{Semana}{it}} + \sum{i=2}^{7} \lambda_i D_{\text{dia da semana}_{it}} + \\
&\quad + \sum_{i=2}^{k} \theta_i D_{\text{feriado}_{it}} + \epsilon_t
\end{split}
\end{equation}

A partir das \ref{reg_energia_com_tendencia} e \ref{reg_energia_sem_tendencia}, usamos os valores preditos para os dados a partir de Março de 2020 como o esperado para o consumo de energia. A diferença percentual mostrada nos gráficos abaixo se baseia nesses valores.

```{r echo = FALSE, warning = FALSE, message = FALSE}
feriados <- read_csv2("../input/feriados.csv") %>% 
    mutate(data = as.Date(data, "%d/%m/%Y"))
```

```{r echo = FALSE, warning = FALSE, message = FALSE}
pre_covid_df_fun <- function(df, tendencia = TRUE) {
    
    list_df <- df %>% 
        left_join(feriados) %>% 
		group_by(data, estado, feriado) %>% 
		summarise(consumo_diario = sum(consumo)) %>% 
		mutate(pre_covid  = ifelse(data <= as.Date("2020-02-25"), 1, 0),
			   semana     = week(data) %>% factor(),
			   ano        = year(data),
			   dia_semana = wday(data),
			   trend      = as.numeric(data) - as.numeric(as.Date("2018-08-01")),
			   trend2     = trend^2,
			   d_feriado  = ifelse(!is.na(feriado), feriado, 0) %>% factor()
			  ) %>% 
        group_by(estado) %>% 
        group_split()
    
    # regressao nas dummies
    if(tendencia == TRUE){
    mod <- map(list_df,
               ~ lm(consumo_diario ~ semana + factor(ano) + d_feriado +
                                     factor(dia_semana) + trend + trend2, 
                  data = .x %>% filter(pre_covid == 1)))
    } else {
    mod <- map(list_df,
               ~ lm(consumo_diario ~ semana + factor(ano) + d_feriado +
                                     factor(dia_semana) , 
                  data = .x %>% filter(pre_covid == 1)))
        
    }
    r2 <- tibble(estado = unique(df$estado) %>% sort(),
                 r2 = map(mod, summary) %>% map_dbl("r.squared"))
    if(tendencia == TRUE){
    write_xlsx(r2, "../output/r2_tendencia_semana.xlsx") 
    } else {
    write_xlsx(r2,"../output/r2_sem_tendencia_semana.xlsx") 
    }
    
    # adicionar coluna de predito
    pred_df <- map2(.x = list_df, .y = mod, 
                    ~ add_predictions(.x, .y)) %>% 
        bind_rows()
    invisible(r2)
    return(pred_df)
    
}

energy_df_fun <- function(df, df_pre_cov) {
    
    post_df <- df %>% 
        group_by(data, estado) %>% 
        summarise(consumo_diario = sum(consumo)) %>% 
        left_join(df_pre_cov) %>% 
        filter(data >= as.Date("2020-01-01")) %>% 
        mutate(dif_baseline = (consumo_diario - pred) / pred) %>% 
        full_join(bases_estados_df, by = c("data" = "date", "estado" = "estado")) %>%
        filter(estado != "Roraima") %>% 
        group_by(estado) %>% 
        arrange(estado, data) %>% 
        mutate(smth_consumo = rollmean(dif_baseline, 7, na.pad = T, align = "right"))
    
}

# consumo total -----------------------------------------------------------
##Com tendêcia quadrática 
pre_covid_com_tendecia <- energy %>% 
    pre_covid_df_fun()

total_energy_df_com_tendencia <- energy %>% 
    energy_df_fun(pre_covid_com_tendecia)

##Sem tendência
pre_covid_sem_tendecia <- energy %>% 
    pre_covid_df_fun(tendencia = FALSE)

total_energy_df_sem_tendencia <- energy %>% 
    energy_df_fun(pre_covid_sem_tendecia)


# consumo acl -------------------------------------------------------------
##Com tendêcia quadrática 
acl_pre_covid_com_tendencia <- energy %>% 
    filter(classe == "Consumidor Especial" | classe == "Consumidor Livre") %>% 
    filter(estado != "Amapa") %>%   # só tem dados de distribuidor
    pre_covid_df_fun() %>% 
    filter(!is.na(pred))


acl_energy_df_com_tendencia <- energy %>% 
    filter(classe == "Consumidor Especial" | classe == "Consumidor Livre") %>% 
    energy_df_fun(acl_pre_covid_com_tendencia) %>% 
    filter(!is.na(pred))


##Sem tendêcia  
acl_pre_covid_sem_tendencia <- energy %>% 
    filter(classe == "Consumidor Especial" | classe == "Consumidor Livre") %>% 
    filter(estado != "Amapa") %>%   # só tem dados de distribuidor
    pre_covid_df_fun(tendencia = FALSE) %>% 
    filter(!is.na(pred))


acl_energy_df_sem_tendencia <- energy %>% 
    filter(classe == "Consumidor Especial" | classe == "Consumidor Livre") %>% 
    energy_df_fun(acl_pre_covid_sem_tendencia) %>% 
    filter(!is.na(pred))

```

```{r echo = FALSE, warning = FALSE, message = FALSE}
#Calculando R2
r_sqrared_fun <- function(df,mod){
    r2 <- tibble(estado = unique(df$estado) %>% sort(),
                 r2 = map(mod, summary) %>% map_dbl("r.squared"))
}



```

```{r echo = FALSE, warning = FALSE, message = FALSE}
plot_activity_energy <- function(df) {
    
    p <- ggplot(df, aes(x = smth_date, y = smth_consumo)) +
		geom_path(color = "steelblue", size = 0.8) +
        geom_hline(yintercept = 0, color = "red") +
		xlim(0, 40) + 
		facet_wrap(~ estado) +
		ylab("Change from predicted in energy consumption") + xlab("Doubling days of confirmed cases")
    
    return(p)
}


plot_regiao_energia <- function(df, reg) {
    
    base_regiao <- df %>% 
        filter(regiao == reg)
    
    return(plot_activity_energy(base_regiao)) 
}
```


Trocando os dados de mobilidade pela diferença percentual entre o consumo de energia atual e o esperado.

## Região Sudeste
**Total de Consumo**
**Com tendência quadrática**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(total_energy_df_com_tendencia, "Sudeste")
```

**Sem tendência**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(total_energy_df_sem_tendencia, "Sudeste")
```

\pagebreak
**Somente ACL**  
**Com tendência quadrática**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(acl_energy_df_com_tendencia, "Sudeste")
```
**Sem tendência**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(acl_energy_df_sem_tendencia, "Sudeste")
```


\pagebreak
## Região Sul
**Total de Consumo**
**Com tendência quadrática**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(total_energy_df_com_tendencia, "Sul")
```

**Sem tendência**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(total_energy_df_sem_tendencia, "Sul")
```

\pagebreak
**Somente ACL**  
**Com tendência quadrática**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(acl_energy_df_com_tendencia, "Sul")
```
**Sem tendência**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(acl_energy_df_sem_tendencia, "Sul")
```



\pagebreak

## Região Centro-Oeste
**Total de Consumo**
**Com tendência quadrática**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(total_energy_df_com_tendencia, "Centro-Oeste")
```

**Sem tendência**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(total_energy_df_sem_tendencia, "Centro-Oeste")
```

\pagebreak
**Somente ACL**  
**Com tendência quadrática**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(acl_energy_df_com_tendencia, "Centro-Oeste")
```
**Sem tendência**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(acl_energy_df_sem_tendencia, "Centro-Oeste")
```

\pagebreak
## Região Nordeste

**Total de Consumo**
**Com tendência quadrática**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(total_energy_df_com_tendencia, "Nordeste")
```
**Sem tendência**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(total_energy_df_sem_tendencia, "Nordeste")
```

\pagebreak
**Somente ACL**  
**Com tendência quadrática**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(acl_energy_df_com_tendencia, "Nordeste")
```
**Sem tendência**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(acl_energy_df_sem_tendencia, "Nordeste")
```

\pagebreak
## Região Norte

**Total de Consumo**
**Com tendência quadrática**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(total_energy_df_com_tendencia, "Norte")
```
**Sem tendência**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(total_energy_df_sem_tendencia, "Norte")
```

\pagebreak
**Somente ACL**  
**Com tendência quadrática**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(acl_energy_df_com_tendencia, "Norte")
```
**Sem tendência**
```{r echo = FALSE, warning = FALSE, fig.width = 9, fig.height = 6}
plot_regiao_energia(acl_energy_df_sem_tendencia, "Norte")
```
